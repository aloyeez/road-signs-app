import React, { useState } from 'react';
import {
  IonPage,
  IonHeader,
  IonToolbar,
  IonContent,
  IonIcon,
} from '@ionic/react';
import { arrowBackOutline } from 'ionicons/icons';
import { useHistory } from 'react-router-dom';
import {
  Box,
  VStack,
  HStack,
  Heading,
  Text,
  IconButton,
  Container,
  Flex,
  Badge,
  Button,
  Grid,
} from '@chakra-ui/react';
import { Moon, Sun, CheckCircle, XCircle, RotateCcw, ArrowRight } from 'lucide-react';
import { useColorMode } from '@chakra-ui/color-mode';
import { czechRoadSigns, type RoadSign } from '../../data/czechSigns';

// Use imported Czech road signs data
const roadSigns = czechRoadSigns;

interface QuizQuestion {
  sign: RoadSign;
  options: string[];
  correctAnswer: string;
}

const QuizCZ: React.FC = () => {
  const history = useHistory();
  const { colorMode, toggleColorMode } = useColorMode();

  // Category selection
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [quizStarted, setQuizStarted] = useState(false);

  // Quiz state
  const [questions, setQuestions] = useState<QuizQuestion[]>([]);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState<string | null>(null);
  const [showResult, setShowResult] = useState(false);
  const [correctAnswers, setCorrectAnswers] = useState<number[]>([]);
  const [wrongAnswers, setWrongAnswers] = useState<number[]>([]);
  const [quizFinished, setQuizFinished] = useState(false);

  const categories = ['Random', 'Warning', 'Prohibition'];

  // Generate quiz questions
  const generateQuiz = (category: string) => {
    let selectedSigns = [...roadSigns];

    if (category !== 'Random') {
      selectedSigns = roadSigns.filter(sign => sign.category === category);
    }

    // Shuffle and select 20 signs (or all if less than 20)
    const shuffled = selectedSigns.sort(() => 0.5 - Math.random());
    const quizSigns = shuffled.slice(0, Math.min(20, selectedSigns.length));

    // Generate questions with 4 options each
  {
    id: 2,
    name: 'Zat√°ƒçka vlevo',
    czechName: 'Zat√°ƒçka vlevo',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na smƒõrov√Ω oblouk.',
    image: '/assets/signs/cz/zatacka_vlevo.png',
    color: 'yellow',
  },
  {
    id: 3,
    name: 'Dvojit√° zat√°ƒçka, prvn√≠ vpravo',
    czechName: 'Dvojit√° zat√°ƒçka, prvn√≠ vpravo',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na dva po sobƒõ n√°sleduj√≠c√≠ protismƒõrn√© smƒõrov√© oblouky.',
    image: '/assets/signs/cz/dvojita_zatacka_prvni_vpravo.png',
    color: 'yellow',
  },
  {
    id: 4,
    name: 'Dvojit√° zat√°ƒçka, prvn√≠ vlevo',
    czechName: 'Dvojit√° zat√°ƒçka, prvn√≠ vlevo',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na dva po sobƒõ n√°sleduj√≠c√≠ protismƒõrn√© smƒõrov√© oblouky.',
    image: '/assets/signs/cz/dvojita_zatacka_prvni_vlevo.png',
    color: 'yellow',
  },
  {
    id: 5,
    name: 'K≈ôi≈æovatka',
    czechName: 'K≈ôi≈æovatka',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na k≈ôi≈æovatku, kde nen√≠ p≈ôednost v j√≠zdƒõ upravena svisl√Ωmi dopravn√≠mi znaƒçkami.',
    image: '/assets/signs/cz/krizovatka.png',
    color: 'yellow',
  },
  {
    id: 6,
    name: 'K≈ôi≈æovatka s kruhov√Ωm objezdem',
    czechName: 'K≈ôi≈æovatka s kruhov√Ωm objezdem',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na k≈ôi≈æovatku s kruhov√Ωm objezdem.',
    image: '/assets/signs/cz/krizovatka_s_kruhovym_objezdem.png',
    color: 'yellow',
  },
  {
    id: 7,
    name: 'Nebezpeƒçn√© kles√°n√≠',
    czechName: 'Nebezpeƒçn√© kles√°n√≠',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na √∫sek, kde kles√°n√≠ vozovky p≈ôesahuje 10 % nebo kde m√≠stn√≠ podm√≠nky ƒçin√≠ kles√°n√≠ nebezpeƒçn√Ωm.',
    image: '/assets/signs/cz/nebezpecne_klesani.png',
    color: 'yellow',
  },
  {
    id: 8,
    name: 'Nebezpeƒçn√© stoup√°n√≠',
    czechName: 'Nebezpeƒçn√© stoup√°n√≠',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na √∫sek, kde stoup√°n√≠ vozovky p≈ôesahuje 10 % nebo kde m√≠stn√≠ podm√≠nky ƒçin√≠ stoup√°n√≠ nebezpeƒçn√Ωm.',
    image: '/assets/signs/cz/nebezpecne_stoupani.png',
    color: 'yellow',
  },
  {
    id: 9,
    name: 'Z√∫≈æen√° vozovka (z obou stran)',
    czechName: 'Z√∫≈æen√° vozovka (z obou stran)',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde se vozovka zu≈æuje oproti p≈ôedchoz√≠mu √∫seku.',
    image: '/assets/signs/cz/zuzena_vozovka_z_obou_stran.png',
    color: 'yellow',
  },
  {
    id: 10,
    name: 'Z√∫≈æen√° vozovka (z jedn√© strany)',
    czechName: 'Z√∫≈æen√° vozovka (z jedn√© strany)',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde se vozovka zu≈æuje z jedn√© strany.',
    image: '/assets/signs/cz/zuzena_vozovka_z_jedne_strany1.png',
    color: 'yellow',
  },
  {
    id: 11,
    name: 'Nerovnost vozovky',
    czechName: 'Nerovnost vozovky',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na jednotliv√© nerovnosti nebo √∫sek s nerovn√Ωm povrchem vozovky.',
    image: '/assets/signs/cz/nerovnost_vozovky.png',
    color: 'yellow',
  },
  {
    id: 12,
    name: 'Zpomalovac√≠ pr√°h',
    czechName: 'Zpomalovac√≠ pr√°h',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na umƒõlou nerovnost na vozovce.',
    image: '/assets/signs/cz/zpomalovaci_prah.png',
    color: 'yellow',
  },
  {
    id: 13,
    name: 'Nebezpeƒç√≠ smyku',
    czechName: 'Nebezpeƒç√≠ smyku',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto nebo √∫sek, kde m≈Ø≈æe vozidlo snadno dostat smyk.',
    image: '/assets/signs/cz/nebezpeci_smyku.png',
    color: 'yellow',
  },
  {
    id: 14,
    name: 'Provoz v obou smƒõrech',
    czechName: 'Provoz v obou smƒõrech',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na √∫sek, kde na rozd√≠l od p≈ôedchoz√≠ho √∫seku je provoz v obou smƒõrech.',
    image: '/assets/signs/cz/provoz_v_obou_smerech.png',
    color: 'yellow',
  },
  {
    id: 15,
    name: 'Svƒõteln√© sign√°ly',
    czechName: 'Svƒõteln√© sign√°ly',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde je provoz ≈ô√≠zen svƒõteln√Ωmi sign√°ly.',
    image: '/assets/signs/cz/svetelne_signaly.png',
    color: 'yellow',
  },
  {
    id: 16,
    name: 'P≈ôechod pro chodce',
    czechName: 'P≈ôechod pro chodce',
    category: 'V√Ωstra≈æn√©',
    description: 'P≈ôedem varuje p≈ôed p≈ôechodem pro chodce.',
    image: '/assets/signs/cz/prechod_pro_chodce.png',
    color: 'yellow',
  },
  {
    id: 17,
    name: 'Chodci',
    czechName: 'Chodci',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto nebo √∫sek s ƒçast√Ωm v√Ωskytem chodc≈Ø.',
    image: '/assets/signs/cz/chodci.png',
    color: 'yellow',
  },
  {
    id: 18,
    name: 'Dƒõti',
    czechName: 'Dƒõti',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde se ƒçasto pohybuj√≠ dƒõti.',
    image: '/assets/signs/cz/deti.png',
    color: 'yellow',
  },
  {
    id: 19,
    name: 'Zv√≠≈ôata',
    czechName: 'Zv√≠≈ôata',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto s ƒçast√Ωm v√Ωskytem dom√°c√≠ch zv√≠≈ôat na vozovce.',
    image: '/assets/signs/cz/zvirata.png',
    color: 'yellow',
  },
  {
    id: 20,
    name: 'Zvƒõ≈ô',
    czechName: 'Zvƒõ≈ô',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto s ƒçast√Ωm v√Ωskytem zvƒõ≈ôe na vozovce.',
    image: '/assets/signs/cz/zver.png',
    color: 'yellow',
  },
  {
    id: 21,
    name: 'Pr√°ce na silnici',
    czechName: 'Pr√°ce na silnici',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na pr√°ce na silnici.',
    image: '/assets/signs/cz/prace_na_silnici.png',
    color: 'yellow',
  },
  {
    id: 22,
    name: 'Boƒçn√≠ v√≠tr',
    czechName: 'Boƒçn√≠ v√≠tr',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na √∫sek, kde m≈Ø≈æe siln√Ω boƒçn√≠ v√≠tr ohrozit bezpeƒçnost.',
    image: '/assets/signs/cz/bocni_vitr.png',
    color: 'yellow',
  },
  {
    id: 23,
    name: 'Odl√©t√°vaj√≠c√≠ ≈°tƒõrk',
    czechName: 'Odl√©t√°vaj√≠c√≠ ≈°tƒõrk',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto s voln√Ωm ≈°tƒõrkem na vozovce.',
    image: '/assets/signs/cz/odletavajici_sterk.png',
    color: 'yellow',
  },
  {
    id: 24,
    name: 'Kamen√≠ na vozovce',
    czechName: 'Kamen√≠ na vozovce',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde mohou na vozovku padat kameny.',
    image: '/assets/signs/cz/kameni_na_vozovce.png',
    color: 'yellow',
  },
  {
    id: 25,
    name: 'Cyklist√©',
    czechName: 'Cyklist√©',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde cyklist√© vj√≠≈ædƒõj√≠ nebo p≈ôej√≠≈ædƒõj√≠ vozovku.',
    image: '/assets/signs/cz/cykliste.png',
    color: 'yellow',
  },
  {
    id: 26,
    name: 'Letadla',
    czechName: 'Letadla',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde l√©taj√≠ letadla v n√≠zk√© v√Ω≈°ce nad silnic√≠.',
    image: '/assets/signs/cz/letadla.png',
    color: 'yellow',
  },
  {
    id: 27,
    name: 'Tunel',
    czechName: 'Tunel',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na tunel.',
    image: '/assets/signs/cz/tunel.png',
    color: 'yellow',
  },
  {
    id: 28,
    name: 'Jin√© nebezpeƒç√≠',
    czechName: 'Jin√© nebezpeƒç√≠',
    category: 'V√Ωstra≈æn√©',
    description: 'Varuje p≈ôed jin√Ωmi nebezpeƒç√≠mi.',
    image: '/assets/signs/cz/letadla.png',
    color: 'yellow',
  },
  {
    id: 29,
    name: 'Kolona',
    czechName: 'Kolona',
    category: 'V√Ωstra≈æn√©',
    description: 'Varuje p≈ôed kolonou stoj√≠c√≠ch nebo pomalu se pohybuj√≠c√≠ch vozidel.',
    image: '/assets/signs/cz/kolona.png',
    color: 'yellow',
  },
  {
    id: 30,
    name: 'N√°led√≠',
    czechName: 'N√°led√≠',
    category: 'V√Ωstra≈æn√©',
    description: 'Varuje p≈ôed √∫sekem s ƒçast√Ωm v√Ωskytem n√°mrazy na vozovce.',
    image: '/assets/signs/cz/naledi.png',
    color: 'yellow',
  },
  {
    id: 31,
    name: 'Tramvaj',
    czechName: 'Tramvaj',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto, kde tramvaj k≈ôi≈æuje smƒõr j√≠zdy jin√Ωch vozidel.',
    image: '/assets/signs/cz/tramvaj.png',
    color: 'yellow',
  },
  {
    id: 32,
    name: 'Mlha',
    czechName: 'Mlha',
    category: 'V√Ωstra≈æn√©',
    description: 'Varuje p≈ôed v√Ωskytem mlhy sni≈æuj√≠c√≠ viditelnost.',
    image: '/assets/signs/cz/mlha.png',
    color: 'yellow',
  },
  {
    id: 33,
    name: 'Nehoda',
    czechName: 'Nehoda',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na m√≠sto dopravn√≠ nehody.',
    image: '/assets/signs/cz/nehoda.png',
    color: 'yellow',
  },
  {
    id: 34,
    name: 'Nebezpeƒçn√° krajnice',
    czechName: 'Nebezpeƒçn√° krajnice',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na √∫sek, kde je nebezpeƒçn√© naj√≠≈ædƒõt na krajnici.',
    image: '/assets/signs/cz/nebezpecna_krajnice.png',
    color: 'yellow',
  },
  {
    id: 35,
    name: '≈Ωelezniƒçn√≠ p≈ôejezd se z√°vorami',
    czechName: '≈Ωelezniƒçn√≠ p≈ôejezd se z√°vorami',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na ≈æelezniƒçn√≠ p≈ôejezd vybaven√Ω z√°vorami.',
    image: '/assets/signs/cz/zeleznicni_prejezd_se_zavorami.png',
    color: 'yellow',
  },
  {
    id: 36,
    name: '≈Ωelezniƒçn√≠ p≈ôejezd bez z√°vor',
    czechName: '≈Ωelezniƒçn√≠ p≈ôejezd bez z√°vor',
    category: 'V√Ωstra≈æn√©',
    description: 'Upozor≈àuje na ≈æelezniƒçn√≠ p≈ôejezd bez z√°vor.',
    image: '/assets/signs/cz/zeleznicni_prejezd_bez_zavor.png',
    color: 'yellow',
  },
  {
    id: 37,
    name: 'N√°vƒõstn√≠ deska (240 m)',
    czechName: 'N√°vƒõstn√≠ deska (240 m)',
    category: 'V√Ωstra≈æn√©',
    description: 'P≈ôedem varuje p≈ôed ≈æelezniƒçn√≠m p≈ôejezdem.',
    image: '/assets/signs/cz/navestni_deska_240.png',
    color: 'yellow',
  },
  {
    id: 38,
    name: 'N√°vƒõstn√≠ deska (160 m)',
    czechName: 'N√°vƒõstn√≠ deska (160 m)',
    category: 'V√Ωstra≈æn√©',
    description: 'P≈ôedem varuje p≈ôed ≈æelezniƒçn√≠m p≈ôejezdem.',
    image: '/assets/signs/cz/navestni_deska_160.png',
    color: 'yellow',
  },
  {
    id: 39,
    name: 'N√°vƒõstn√≠ deska (80 m)',
    czechName: 'N√°vƒõstn√≠ deska (80 m)',
    category: 'V√Ωstra≈æn√©',
    description: 'P≈ôedem varuje p≈ôed ≈æelezniƒçn√≠m p≈ôejezdem.',
    image: '/assets/signs/cz/navestni_deska_80.png',
    color: 'yellow',
  },
  {
    id: 40,
    name: 'V√Ωstra≈æn√Ω k≈ô√≠≈æ jednokolejn√Ω',
    czechName: 'V√Ωstra≈æn√Ω k≈ô√≠≈æ pro ≈æelezniƒçn√≠ p≈ôejezd jednokolejn√Ω',
    category: 'V√Ωstra≈æn√©',
    description: 'Oznaƒçuje ≈æelezniƒçn√≠ p≈ôejezd jednokolejn√© trati.',
    image: '/assets/signs/cz/Czech_Republic_road_sign_A_32a.png',
    color: 'yellow',
  },
  {
    id: 41,
    name: 'V√Ωstra≈æn√Ω k≈ô√≠≈æ v√≠cekolejn√Ω',
    czechName: 'V√Ωstra≈æn√Ω k≈ô√≠≈æ pro ≈æelezniƒçn√≠ p≈ôejezd v√≠cekolejn√Ω',
    category: 'V√Ωstra≈æn√©',
    description: 'Oznaƒçuje ≈æelezniƒçn√≠ p≈ôejezd v√≠cekolejn√© trati.',
    image: '/assets/signs/cz/A32b.png',
    color: 'yellow',
  },
  {
    id: 42,
    name: 'Z√°kaz vjezdu v≈°ech vozidel',
    czechName: 'Z√°kaz vjezdu v≈°ech vozidel',
    category: 'Z√°kazov√©',
    description: 'Vjezd v≈°ech vozidel zak√°z√°n.',
    image: '/assets/signs/cz/zakaz_vjezdu_vsech_vozidel.png',
    color: 'red',
  },
];

interface QuizQuestion {
  sign: typeof roadSigns[0];
  options: string[];
  correctAnswer: string;
}

const QuizCZ: React.FC = () => {
  const history = useHistory();
  const { colorMode, toggleColorMode } = useColorMode();

  // Category selection
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [quizStarted, setQuizStarted] = useState(false);

  // Quiz state
  const [questions, setQuestions] = useState<QuizQuestion[]>([]);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState<string | null>(null);
  const [showResult, setShowResult] = useState(false);
  const [correctAnswers, setCorrectAnswers] = useState<number[]>([]);
  const [wrongAnswers, setWrongAnswers] = useState<number[]>([]);
  const [quizFinished, setQuizFinished] = useState(false);

  const categories = ['N√°hodn√°', 'V√Ωstra≈æn√©', 'Z√°kazov√©'];

  // Generate quiz questions
  const generateQuiz = (category: string) => {
    let selectedSigns = [...roadSigns];

    if (category !== 'N√°hodn√°') {
      selectedSigns = roadSigns.filter(sign => sign.category === category);
    }

    // Shuffle and select 20 signs (or all if less than 20)
    const shuffled = selectedSigns.sort(() => 0.5 - Math.random());
    const quizSigns = shuffled.slice(0, Math.min(20, selectedSigns.length));

    // Generate questions with 4 options each
    const generatedQuestions: QuizQuestion[] = quizSigns.map(sign => {
      const correctAnswer = sign.czechName;

      // Get 3 random wrong answers from other signs
      const otherSigns = roadSigns.filter(s => s.id !== sign.id);
      const wrongOptions = otherSigns
        .sort(() => 0.5 - Math.random())
        .slice(0, 3)
        .map(s => s.czechName);

      // Combine and shuffle options
      const options = [correctAnswer, ...wrongOptions].sort(() => 0.5 - Math.random());

      return {
        sign,
        options,
        correctAnswer,
      };
    });

    setQuestions(generatedQuestions);
    setQuizStarted(true);
  };

  const handleCategorySelect = (category: string) => {
    setSelectedCategory(category);
    generateQuiz(category);
  };

  const handleAnswerSelect = (answer: string) => {
    if (selectedAnswer || showResult) return;

    setSelectedAnswer(answer);
    setShowResult(true);

    const currentQuestion = questions[currentQuestionIndex];
    const isCorrect = answer === currentQuestion.correctAnswer;

    if (isCorrect) {
      setCorrectAnswers([...correctAnswers, currentQuestionIndex]);
    } else {
      setWrongAnswers([...wrongAnswers, currentQuestionIndex]);
    }
  };

  const handleNextQuestion = () => {
    if (currentQuestionIndex < questions.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);
      setSelectedAnswer(null);
      setShowResult(false);
    } else {
      setQuizFinished(true);
    }
  };

  const handleRestartQuiz = () => {
    setSelectedCategory(null);
    setQuizStarted(false);
    setQuestions([]);
    setCurrentQuestionIndex(0);
    setSelectedAnswer(null);
    setShowResult(false);
    setCorrectAnswers([]);
    setWrongAnswers([]);
    setQuizFinished(false);
  };

  const currentQuestion = questions[currentQuestionIndex];
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;

  return (
    <IonPage>
      <IonHeader className="ion-no-border">
        <IonToolbar
          style={{
            '--background': colorMode === 'light' ? '#ffffff' : '#2c1810',
            '--border-width': '0',
            '--padding-top': '12px',
            '--padding-bottom': '12px',
          }}
        >
          <Box
            px={4}
            py={3}
            bg={colorMode === 'light' ? 'white' : '#2c1810'}
            borderBottomWidth="1px"
            borderBottomColor={colorMode === 'light' ? '#d4a574' : '#8b6f47'}
          >
            <Flex justify="space-between" align="center">
              <HStack gap={3}>
                <IconButton
                  aria-label="Go back"
                  variant="ghost"
                  size="md"
                  onClick={() => history.goBack()}
                  borderRadius="full"
                  color={colorMode === 'light' ? '#5d4037' : '#bcaaa4'}
                  _hover={{
                    bg: colorMode === 'light' ? '#f5e6d3' : '#3e2723',
                    color: colorMode === 'light' ? '#d4a574' : '#d4a574',
                  }}
                >
                  <IonIcon icon={arrowBackOutline} style={{ fontSize: '22px' }} />
                </IconButton>
                <HStack gap={2}>
                  <Box
                    fontSize="2xl"
                    bg={colorMode === 'light' ? '#f5e6d3' : '#3e2723'}
                    px={2}
                    py={1}
                    borderRadius="lg"
                    borderWidth="1px"
                    borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                  >
                    üß†
                  </Box>
                  <VStack align="start" gap={0}>
                    <Heading size="md" color={colorMode === 'light' ? '#3e2723' : '#d7ccc8'} fontWeight="bold" letterSpacing="tight">
                      Quiz
                    </Heading>
                    <Text fontSize="xs" color={colorMode === 'light' ? '#d4a574' : '#d4a574'}>
                      ƒåesk√° republika
                    </Text>
                  </VStack>
                </HStack>
              </HStack>

              <IconButton
                aria-label="Toggle color mode"
                variant="ghost"
                size="md"
                onClick={toggleColorMode}
                borderRadius="full"
                color={colorMode === 'light' ? '#5d4037' : '#bcaaa4'}
                _hover={{
                  bg: colorMode === 'light' ? '#f5e6d3' : '#3e2723',
                  color: colorMode === 'light' ? '#d4a574' : '#d4a574',
                }}
              >
                {colorMode === 'light' ? <Moon size={20} /> : <Sun size={20} />}
              </IconButton>
            </Flex>
          </Box>
        </IonToolbar>
      </IonHeader>

      <IonContent fullscreen>
        <Box
          minH="100vh"
          bg={colorMode === 'light' ? '#faf8f5' : '#1a0f0a'}
          py={8}
        >
          <Container maxW="container.md">
            <VStack gap={6} align="stretch">
              {/* Category Selection */}
              {!quizStarted && !quizFinished && (
                <>
                  <Box
                    p={6}
                    borderRadius="xl"
                    bg={colorMode === 'light' ? 'white' : '#2c1810'}
                    borderWidth="1px"
                    borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                    textAlign="center"
                  >
                    <VStack gap={4}>
                      <Box fontSize="4xl">üéØ</Box>
                      <Heading size="lg" color={colorMode === 'light' ? '#3e2723' : '#d7ccc8'}>
                        Vyberte kategorii
                      </Heading>
                      <Text color={colorMode === 'light' ? '#795548' : '#8d6e63'} fontSize="sm">
                        Zvolte kategorii znaƒçek nebo n√°hodn√Ω mix 20 znaƒçek
                      </Text>
                    </VStack>
                  </Box>

                  <VStack gap={4} align="stretch">
                    {categories.map((category) => {
                      const signsInCategory = category === 'N√°hodn√°'
                        ? roadSigns.length
                        : roadSigns.filter(s => s.category === category).length;

                      return (
                        <Box
                          key={category}
                          p={6}
                          borderRadius="xl"
                          bg={colorMode === 'light' ? 'white' : '#2c1810'}
                          borderWidth="1px"
                          borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                          cursor="pointer"
                          onClick={() => handleCategorySelect(category)}
                          _hover={{
                            transform: 'translateY(-4px)',
                            shadow: 'xl',
                            borderColor: colorMode === 'light' ? '#d4a574' : '#d4a574',
                          }}
                          transition="all 0.3s ease"
                        >
                          <HStack justify="space-between">
                            <VStack align="start" gap={1}>
                              <Heading size="md" color={colorMode === 'light' ? '#3e2723' : '#d7ccc8'}>
                                {category}
                              </Heading>
                              <Text fontSize="sm" color={colorMode === 'light' ? '#795548' : '#8d6e63'}>
                                {Math.min(20, signsInCategory)} znaƒçek v kv√≠zu
                              </Text>
                            </VStack>
                            <Badge
                              bg={colorMode === 'light' ? '#f5e6d3' : '#3e2723'}
                              color={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                              fontSize="md"
                              px={3}
                              py={1}
                              borderRadius="full"
                            >
                              {signsInCategory} dostupn√Ωch
                            </Badge>
                          </HStack>
                        </Box>
                      );
                    })}
                  </VStack>
                </>
              )}

              {/* Quiz Questions */}
              {quizStarted && !quizFinished && currentQuestion && (
                <>
                  {/* Progress Bar */}
                  <Box
                    p={4}
                    borderRadius="xl"
                    bg={colorMode === 'light' ? 'white' : '#2c1810'}
                    borderWidth="1px"
                    borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                  >
                    <VStack gap={2}>
                      <HStack justify="space-between" w="100%">
                        <Text fontSize="sm" color={colorMode === 'light' ? '#795548' : '#8d6e63'}>
                          Ot√°zka {currentQuestionIndex + 1} / {questions.length}
                        </Text>
                        <Badge
                          bg={colorMode === 'light' ? '#f5e6d3' : '#3e2723'}
                          color={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                        >
                          {selectedCategory}
                        </Badge>
                      </HStack>
                      <Box w="100%" h="6px" bg={colorMode === 'light' ? '#e8dcc8' : '#5d4037'} borderRadius="full" overflow="hidden">
                        <Box
                          h="100%"
                          w={`${progress}%`}
                          bg={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                          transition="width 0.3s ease"
                        />
                      </Box>
                    </VStack>
                  </Box>

                  {/* Question Card */}
                  <Box
                    p={6}
                    borderRadius="xl"
                    bg={colorMode === 'light' ? 'white' : '#2c1810'}
                    borderWidth="1px"
                    borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                  >
                    <VStack gap={6}>
                      <Box
                        w="200px"
                        h="200px"
                        borderRadius="xl"
                        overflow="hidden"
                        bg={colorMode === 'light' ? '#faf8f5' : '#1a0f0a'}
                        display="flex"
                        alignItems="center"
                        justifyContent="center"
                        p={4}
                        borderWidth="1px"
                        borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                      >
                        <img
                          src={currentQuestion.sign.image}
                          alt="Dopravn√≠ znaƒçka"
                          onError={(e) => {
                            const target = e.target as HTMLImageElement;
                            target.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23d4a574" width="200" height="200" rx="10"/%3E%3Ctext x="50%25" y="50%25" font-size="60" text-anchor="middle" dy=".3em" fill="white"%3E?%3C/text%3E%3C/svg%3E';
                          }}
                          style={{
                            width: '100%',
                            height: '100%',
                            objectFit: 'contain',
                          }}
                        />
                      </Box>

                      <Heading size="md" color={colorMode === 'light' ? '#3e2723' : '#d7ccc8'} textAlign="center">
                        Jak se tato znaƒçka jmenuje?
                      </Heading>
                    </VStack>
                  </Box>

                  {/* Answer Options */}
                  <Grid templateColumns={{ base: '1fr', md: 'repeat(2, 1fr)' }} gap={4}>
                    {currentQuestion.options.map((option, index) => {
                      const isSelected = selectedAnswer === option;
                      const isCorrect = option === currentQuestion.correctAnswer;
                      const showCorrect = showResult && isCorrect;
                      const showWrong = showResult && isSelected && !isCorrect;

                      return (
                        <Box
                          key={index}
                          p={4}
                          borderRadius="xl"
                          bg={
                            showCorrect ? '#16a34a' :
                            showWrong ? '#dc2626' :
                            colorMode === 'light' ? 'white' : '#2c1810'
                          }
                          borderWidth="2px"
                          borderColor={
                            showCorrect ? '#16a34a' :
                            showWrong ? '#dc2626' :
                            isSelected ? colorMode === 'light' ? '#d4a574' : '#d4a574' :
                            colorMode === 'light' ? '#e8dcc8' : '#5d4037'
                          }
                          cursor={showResult ? 'default' : 'pointer'}
                          onClick={() => handleAnswerSelect(option)}
                          _hover={
                            showResult ? {} : {
                              borderColor: colorMode === 'light' ? '#d4a574' : '#d4a574',
                              transform: 'translateY(-2px)',
                            }
                          }
                          transition="all 0.2s ease"
                        >
                          <HStack justify="space-between">
                            <Text
                              fontSize="md"
                              fontWeight="medium"
                              color={
                                showCorrect || showWrong ? 'white' :
                                colorMode === 'light' ? '#3e2723' : '#d7ccc8'
                              }
                            >
                              {option}
                            </Text>
                            {showCorrect && <CheckCircle size={24} color="white" />}
                            {showWrong && <XCircle size={24} color="white" />}
                          </HStack>
                        </Box>
                      );
                    })}
                  </Grid>

                  {/* Next Button */}
                  {showResult && (
                    <Button
                      size="lg"
                      bg={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                      color="white"
                      onClick={handleNextQuestion}
                      _hover={{ opacity: 0.9 }}
                    >
                      <HStack gap={2}>
                        <Text>{currentQuestionIndex < questions.length - 1 ? 'Dal≈°√≠ ot√°zka' : 'Zobrazit v√Ωsledky'}</Text>
                        <ArrowRight size={20} />
                      </HStack>
                    </Button>
                  )}
                </>
              )}

              {/* Quiz Results */}
              {quizFinished && (
                <>
                  <Box
                    p={6}
                    borderRadius="xl"
                    bg={colorMode === 'light' ? 'white' : '#2c1810'}
                    borderWidth="1px"
                    borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                    textAlign="center"
                  >
                    <VStack gap={4}>
                      <Box fontSize="5xl">
                        {correctAnswers.length >= questions.length * 0.8 ? 'üéâ' :
                         correctAnswers.length >= questions.length * 0.6 ? 'üëç' : 'üìö'}
                      </Box>
                      <Heading size="lg" color={colorMode === 'light' ? '#3e2723' : '#d7ccc8'}>
                        Kv√≠z dokonƒçen!
                      </Heading>
                      <Text color={colorMode === 'light' ? '#795548' : '#8d6e63'}>
                        {correctAnswers.length >= questions.length * 0.8
                          ? 'V√Ωborn√° pr√°ce!'
                          : correctAnswers.length >= questions.length * 0.6
                          ? 'Dobr√° pr√°ce! Pokraƒçujte v procviƒçov√°n√≠.'
                          : 'Pokraƒçujte ve studiu a zkuste to znovu!'}
                      </Text>
                    </VStack>
                  </Box>

                  <Box
                    p={6}
                    borderRadius="xl"
                    bg={colorMode === 'light' ? 'white' : '#2c1810'}
                    borderWidth="1px"
                    borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                  >
                    <VStack gap={4}>
                      <Heading size="md" color={colorMode === 'light' ? '#3e2723' : '#d7ccc8'}>
                        Va≈°e sk√≥re
                      </Heading>

                      <HStack gap={8} justify="center">
                        <VStack>
                          <Box color="#16a34a">
                            <CheckCircle size={48} />
                          </Box>
                          <Text fontSize="3xl" fontWeight="bold" color="#16a34a">
                            {correctAnswers.length}
                          </Text>
                          <Text fontSize="sm" color={colorMode === 'light' ? '#795548' : '#8d6e63'}>
                            Spr√°vnƒõ
                          </Text>
                        </VStack>

                        <VStack>
                          <Box color="#dc2626">
                            <XCircle size={48} />
                          </Box>
                          <Text fontSize="3xl" fontWeight="bold" color="#dc2626">
                            {wrongAnswers.length}
                          </Text>
                          <Text fontSize="sm" color={colorMode === 'light' ? '#795548' : '#8d6e63'}>
                            ≈†patnƒõ
                          </Text>
                        </VStack>
                      </HStack>

                      <Box
                        w="100%"
                        p={4}
                        borderRadius="lg"
                        bg={colorMode === 'light' ? '#f5e6d3' : '#3e2723'}
                      >
                        <Text fontSize="2xl" fontWeight="bold" color={colorMode === 'light' ? '#d4a574' : '#d4a574'}>
                          {Math.round((correctAnswers.length / questions.length) * 100)}%
                        </Text>
                      </Box>
                    </VStack>
                  </Box>

                  <HStack gap={3}>
                    <Button
                      flex={1}
                      size="lg"
                      bg={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                      color="white"
                      onClick={handleRestartQuiz}
                      _hover={{ opacity: 0.9 }}
                    >
                      <HStack gap={2}>
                        <RotateCcw size={20} />
                        <Text>Nov√Ω kv√≠z</Text>
                      </HStack>
                    </Button>
                    <Button
                      flex={1}
                      size="lg"
                      variant="outline"
                      borderColor={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                      color={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                      onClick={() => history.goBack()}
                      _hover={{ opacity: 0.9 }}
                    >
                      Zpƒõt do menu
                    </Button>
                  </HStack>
                </>
              )}

              {/* Info Card */}
              {!quizStarted && !quizFinished && (
                <Box
                  p={6}
                  borderRadius="xl"
                  bg={colorMode === 'light' ? '#f5e6d3' : '#3e2723'}
                  borderWidth="1px"
                  borderColor={colorMode === 'light' ? '#e8dcc8' : '#5d4037'}
                >
                  <HStack gap={3} align="start">
                    <Box
                      bg={colorMode === 'light' ? '#d4a574' : '#d4a574'}
                      color="white"
                      minW="40px"
                      h="40px"
                      borderRadius="full"
                      display="flex"
                      alignItems="center"
                      justifyContent="center"
                      fontSize="xl"
                      flexShrink={0}
                    >
                      üí°
                    </Box>
                    <VStack align="start" gap={1}>
                      <Text fontWeight="bold" fontSize="md" color={colorMode === 'light' ? '#3e2723' : '#d7ccc8'}>
                        Jak to funguje
                      </Text>
                      <Text fontSize="sm" color={colorMode === 'light' ? '#5d4037' : '#a1887f'}>
                        Ka≈æd√Ω kv√≠z obsahuje a≈æ 20 znaƒçek. Uvid√≠te fotku znaƒçky a 4 mo≈ænosti. Vyberte spr√°vn√Ω n√°zev a z√≠skejte body. Hodnƒõ ≈°tƒõst√≠!
                      </Text>
                    </VStack>
                  </HStack>
                </Box>
              )}
            </VStack>
          </Container>
        </Box>
      </IonContent>
    </IonPage>
  );
};

export default QuizCZ;
